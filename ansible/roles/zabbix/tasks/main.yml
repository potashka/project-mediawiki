---
# Установка PostgreSQL (локально для Zabbix)
- name: Install PostgreSQL
  apt:
    name: postgresql
    state: present
    update_cache: yes

# Создание пользователя zabbix в PostgreSQL
- name: Create PostgreSQL user for Zabbix
  become_user: postgres
  postgresql_user:
    name: zabbix
    password: zabbix

# Создание базы данных zabbix
- name: Create Zabbix database
  become_user: postgres
  postgresql_db:
    name: zabbix
    owner: zabbix
    encoding: UTF8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0

# Установка репозитория Zabbix
- name: Install Zabbix repo
  apt:
    deb: https://repo.zabbix.com/zabbix/6.5/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.5-1+ubuntu22.04_all.deb
    state: present

- name: Update apt cache
  apt:
    update_cache: yes

# Установка компонентов Zabbix
- name: Install Zabbix server and frontend
  apt:
    name:
      - zabbix-server-pgsql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-sql-scripts
      - zabbix-agent
    state: present

# Импорт схемы базы данных (schema + images + data)
- name: Load initial Zabbix schema into DB
  become_user: postgres
  shell: |
    zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | psql zabbix
  args:
    executable: /bin/bash
  when: "'zabbix' in group_names"

# Перезапуск сервисов
- name: Ensure services are running
  service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - postgresql
    - zabbix-server
    - apache2
    - zabbix-agent

- name: Create backup target directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/backups/files
    - /opt/backups/db

- name: Upload backup scripts
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
  loop:
    - backup_fs.sh
    - backup_db.sh

- name: Create cron jobs for backup scripts
  cron:
    name: "Daily {{ item.name }}"
    minute: "0"
    hour: "3"
    job: "/usr/local/bin/{{ item.script }}"
  loop:
    - { name: "filesystem backup", script: "backup_fs.sh" }
    - { name: "database backup", script: "backup_db.sh" }
