#!/bin/bash
set -euo pipefail

SRC_DIR="/var/www/html"
DEST_BASE="/opt/backups/files"
DATE="$(date +%F)"
ARCHIVE_PATH="$DEST_BASE/wiki_fs_${DATE}.tar.gz"

mkdir -p "$DEST_BASE"

# Список app-нод (имя -> IP), подставляется из inventory
{% set nodes = [
  {'name': 'mediawiki-1', 'ip': hostvars['mediawiki-1'].ansible_host},
  {'name': 'mediawiki-2', 'ip': hostvars['mediawiki-2'].ansible_host}
] %}

# Синхронизуем контент с обеих нод на backup-сервер
for entry in {% raw %}{{{% endraw %}{% for n in nodes %}"{{ n.name }}@{{ n.ip }}"{% if not loop.last %},{% endif %}{% endfor %}{% raw %}}}{% endraw %}; do
  NODE_NAME="${entry%@*}"
  NODE_IP="${entry#*@}"
  DEST_DIR="$DEST_BASE/${NODE_NAME}_${DATE}"
  mkdir -p "$DEST_DIR"
  # ssh с отключенной проверкой ключа на случай чистой ВМ
  # rsync -a --delete -e "ssh -o StrictHostKeyChecking=no" "ubuntu@${NODE_IP}:${SRC_DIR}/" "$DEST_DIR/"
  rsync -a --delete -e "ssh" "ubuntu@${NODE_IP}:${SRC_DIR}/" "$DEST_DIR/"
done

tar czf "$ARCHIVE_PATH" -C "$DEST_BASE" .
echo "[INFO] $(date -Is) Backup ФС создан: $ARCHIVE_PATH"

# Retention: 14 дней
find "$DEST_BASE" -type f -name '*.tar.gz' -mtime +14 -print -delete
