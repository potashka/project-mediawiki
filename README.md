# üìò –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –≤–∏–∫–∏-—Å–∏—Å—Ç–µ–º—ã –Ω–∞ –±–∞–∑–µ MediaWiki

---

## üìå –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é MediaWiki, —Å –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º:

- –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (2 MediaWiki, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫)
- –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Zabbix)
- —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (fs + –ë–î)
- –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL master/replica)

---

## üó∫Ô∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                       |
|------------------|--------------------------------------------------|
| `nginx-lb`       | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –º–µ–∂–¥—É –¥–≤—É–º—è MediaWiki              |
| `mediawiki-1/2`  | –î–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MediaWiki                         |
| `pg-master`      | –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä PostgreSQL                        |
| `pg-replica`     | –†–µ–ø–ª–∏–∫–∞ PostgreSQL (streaming replication)       |
| `backup-zabbix`  | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Zabbix + —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ        |

---

## üß∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Terraform** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –≤ Yandex.Cloud
- **Ansible** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **PostgreSQL** ‚Äî –°–£–ë–î –¥–ª—è MediaWiki –∏ Zabbix
- **MediaWiki** ‚Äî –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **Zabbix** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **cron + shell** ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üöÄ –®–∞–≥–∏ –∑–∞–ø—É—Å–∫–∞

### 1. –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–µ

```bash
cd Terraform
terraform init
terraform apply -var-file=terraform.tfvars
```

### 2. –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å IP-–∞–¥—Ä–µ—Å–∞ –≤ `ansible/inventory.yaml`

–ò–∑ `terraform output` ‚Üí `external_ips`.

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH-–¥–æ—Å—Ç—É–ø –≤ `group_vars/all.yml`

```yaml
ansible_user: ubuntu
ansible_ssh_private_key_file: ~/.ssh/minio
ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
ansible_become: true
```

### 4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```bash
cd ansible
ansible-playbook site.yml
```

---

## üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞ –º–∞—à–∏–Ω–µ `backup-zabbix` —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è:

- `/usr/local/bin/backup_fs.sh` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∞—Ä—Ö–∏–≤ `/var/www/html`
- `/usr/local/bin/backup_db.sh` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –¥–∞–º–ø –ë–î `my_wiki` —á–µ—Ä–µ–∑ `pg_dump`
- cron-–∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00
- –ë—ç–∫–∞–ø—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/opt/backups/files/` –∏ `/opt/backups/db/`

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Zabbix)

- Zabbix –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å PostgreSQL –∏ Apache (–≤—Å—ë –∫–æ–¥–æ–º, –±–µ–∑ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).

- Ansible –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ö–µ–º—É –≤ –ë–î, –∫–ª–∞–¥—ë—Ç –∫–æ–Ω—Ñ–∏–≥–∏ (zabbix_server.conf, zabbix.conf.php).

- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://<ip_backup>/zabbix.

- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: Admin / zabbix.

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API —Å–æ–∑–¥–∞—ë—Ç—Å—è:

  - hostgroup MediaWiki

  - —Ö–æ—Å—Ç nginx-lb (—Å –∞–≥–µ–Ω—Ç–æ–º –∏ web scenario)

  - web scenario –ø—Ä–æ–≤–µ—Ä–∫–∏ / MediaWiki

  - —à–∞–±–ª–æ–Ω Linux by Zabbix agent

- —Ç—Ä–∏–≥–≥–µ—Ä—ã:

  - HTTP code != 200 (CRIT)

  - Response time > 2000 ms (WARN, avg 5m)

  - Response time > 5000 ms (CRIT, avg 5m)

‚ú® –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ ‚Äî —á–µ—Ä–µ–∑ Ansible-—à–∞–±–ª–æ–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ web-scenario –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã.

üëâ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –ø—Ä–∏–≤—è–∑–∞—Ç—å —à–∞–±–ª–æ–Ω `Template App HTTP Service`.


---

## üîÅ –†–µ–ø–ª–∏–∫–∞—Ü–∏—è PostgreSQL

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `pg_basebackup` –∏ `standby.signal`
- –†–µ–ø–ª–∏–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ `hot standby`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ:

```bash
sudo -u postgres psql -c "SELECT * FROM pg_stat_replication;"
```

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ:

```bash
sudo -u postgres psql -c "SELECT pg_is_in_recovery();"
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π                               | –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ                            |
|----------------------------------------|-------------------------------------------------|
| –í—ã–∫–ª—é—á–µ–Ω–∏–µ `mediawiki-1`               | Nginx –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å `mediawiki-2`      |
| –í—ã–∫–ª—é—á–µ–Ω–∏–µ `pg-master`                 | `pg-replica` –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é              |
| –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ MediaWiki            | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ `tar`-–∞—Ä—Ö–∏–≤–∞              |
| –£–¥–∞–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö                   | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ `pg_dump`                 |

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
Terraform/
‚îú‚îÄ‚îÄ main.tf
‚îú‚îÄ‚îÄ variables.tf
‚îú‚îÄ‚îÄ terraform.tfvars
‚îú‚îÄ‚îÄ providers.tf
‚îú‚îÄ‚îÄ outputs.tf
‚îú‚îÄ‚îÄ versions.tf

ansible/
‚îú‚îÄ‚îÄ inventory.yaml
‚îú‚îÄ‚îÄ ansible.cfg
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îî‚îÄ‚îÄ all.yml
‚îú‚îÄ‚îÄ site.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers/main.yml
‚îÇ   ‚îú‚îÄ‚îÄ mediawiki/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/apache-vhost.j2
‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers/main.yml
‚îÇ   ‚îú‚îÄ‚îÄ zabbix/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ backup_fs.sh.j2
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ backup_db.sh.j2
‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ       ‚îú‚îÄ‚îÄ tasks/main.yml   (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ zabbix-agent)
‚îÇ       ‚îî‚îÄ‚îÄ handlers/main.yml

```

---
## üì¶ –°—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞

```mermaid
graph TD
    A[üë§ User] --> B[‚òÅÔ∏è –ò–Ω—Ç–µ—Ä–Ω–µ—Ç]
    B --> C[üßÆ nginx-lb]
    C --> D1[üñ•Ô∏è mediawiki-1]
    C --> D2[üñ•Ô∏è mediawiki-2]
    D1 --> E[üõ¢Ô∏è pg-master]
    D2 --> E[üõ¢Ô∏è pg-master]
    E --> F[üõ¢Ô∏è pg-replica]

    G[üõ°Ô∏è backup-zabbix]
    G --> E
    G --> D1
    G --> D2
    G --> C
    G --> F
```

---

## üèÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- –ü—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è MediaWiki
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã: –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –±—ç–∫–∞–ø
- –í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–∞–ª—å–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## –®–∞–±–ª–æ–Ω—ã
```
# ansible/group_vars/all.yml

#all.yml
ansible_user: ubuntu
ansible_ssh_private_key_file: ###
ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
ansible_become: true
postgres_version: ###
pg_data_dir: ###

replication_user: ###
replication_password: ###

mediawiki_version: ###
sysadmin_user: ###
sysadmin_password: ###
sysadmin_db: ###

master_host: "{{ hostvars['pg-master'].ansible_host }}"

# Zabbix API 
zabbix_api_url: "http://{{ hostvars['backup-zabbix'].ansible_host }}/zabbix"
zabbix_api_user: ###
zabbix_api_password: ###
backup_ssh_known_hosts:
  - "{{ hostvars['mediawiki-1'].ansible_host }}"
  - "{{ hostvars['mediawiki-2'].ansible_host }}"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ–±-–ø—Ä–æ–≤–µ—Ä–∫–∏
zabbix_http_check_name: "MediaWiki Front"
zabbix_http_check_url: "http://{{ hostvars['nginx-lb'].ansible_host }}/"
zabbix_http_check_delay: "1m"
zabbix_http_check_timeout: "10s"
zabbix_http_check_host: "nginx-lb"
zabbix_http_rt_warn_ms: 2000
zabbix_http_rt_crit_ms: 5000
```


# terraform/terraform.tfvars
```yc_cloud_id   = 
yc_folder_id  = 
yc_zone       = 
instance_image = 

ssh_public_key = ###
instance_user  = 
service_account_key_file = 

virtual_machines = {
  "nginx" = {
    vm_name   = "nginx-lb"
    hostname  = "nginx-lb"
    vm_cpu    = 2
    ram       = 2
    disk      = 30
    disk_name = "nginx-disk"
    role      = "nginx"
  },
  "mediawiki1" = {
    vm_name   = "mediawiki-1"
    hostname  = "mediawiki-1"
    vm_cpu    = 2
    ram       = 4
    disk      = 30
    disk_name = "mediawiki1-disk"
    role      = "mediawiki"
  },
  "mediawiki2" = {
    vm_name   = "mediawiki-2"
    hostname  = "mediawiki-2"
    vm_cpu    = 2
    ram       = 4
    disk      = 30
    disk_name = "mediawiki2-disk"
    role      = "mediawiki"
  },
  "pgmaster" = {
    vm_name   = "pg-master"
    hostname  = "pg-master"
    vm_cpu    = 2
    ram       = 4
    disk      = 30
    disk_name = "pgmaster-disk"
    role      = "postgres"
  },
  "pgreplica" = {
    vm_name   = "pg-replica"
    hostname  = "pg-replica"
    vm_cpu    = 2
    ram       = 4
    disk      = 30
    disk_name = "pgreplica-disk"
    role      = "postgres"
  },
  "zabbix" = {
    vm_name   = "backup-zabbix"
    hostname  = "backup-zabbix"
    vm_cpu    = 2
    ram       = 2
    disk      = 30
    disk_name = "zabbix-disk"
    role      = "zabbix"
  }
}
```



## –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏

**–ê–ª–µ–∫—Å–µ–π –ü–æ—Ç–∞–Ω–∏–Ω**   [e-mail](mailto:avpotanin@gmail.com)
GitHub: [project-mediawiki](https://github.com/potashka)