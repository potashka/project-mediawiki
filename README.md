# üìò –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –≤–∏–∫–∏-—Å–∏—Å—Ç–µ–º—ã –Ω–∞ –±–∞–∑–µ MediaWiki

---

## üìå –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é MediaWiki, —Å –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º:

- –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (2 MediaWiki, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫)
- –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Zabbix)
- —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (fs + –ë–î)
- –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL master/replica)

---

## üó∫Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                       |
|------------------|--------------------------------------------------|
| `nginx-lb`       | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –º–µ–∂–¥—É –¥–≤—É–º—è MediaWiki              |
| `mediawiki-1/2`  | –î–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MediaWiki                         |
| `pg-master`      | –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä PostgreSQL                        |
| `pg-replica`     | –†–µ–ø–ª–∏–∫–∞ PostgreSQL (streaming replication)       |
| `backup-zabbix`  | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Zabbix + —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ        |

---

## üß∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Terraform** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –≤ Yandex.Cloud
- **Ansible** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **PostgreSQL** ‚Äî –°–£–ë–î –¥–ª—è MediaWiki –∏ Zabbix
- **MediaWiki** ‚Äî –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **Zabbix** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **cron + shell** ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üöÄ –®–∞–≥–∏ –∑–∞–ø—É—Å–∫–∞

### 1. –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–µ

```bash
cd Terraform
terraform init
terraform apply -var-file=terraform.tfvars
```

### 2. –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å IP-–∞–¥—Ä–µ—Å–∞ –≤ `ansible/inventory.yaml`

–ò–∑ `terraform output` ‚Üí `external_ips`.

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH-–¥–æ—Å—Ç—É–ø –≤ `group_vars/all.yml`

```yaml
ansible_user: ubuntu
ansible_ssh_private_key_file: ~/.ssh/minio
ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
ansible_become: true
```

### 4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```bash
cd ansible
ansible-playbook site.yml
```

---

## üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞ –º–∞—à–∏–Ω–µ `backup-zabbix` —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è:

- `/usr/local/bin/backup_fs.sh` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∞—Ä—Ö–∏–≤ `/var/www/html`
- `/usr/local/bin/backup_db.sh` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –¥–∞–º–ø –ë–î `my_wiki` —á–µ—Ä–µ–∑ `pg_dump`
- cron-–∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00
- –ë—ç–∫–∞–ø—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/opt/backups/files/` –∏ `/opt/backups/db/`

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Zabbix)

- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: `http://<ip_backup>/zabbix`
- –õ–æ–≥–∏–Ω: `Admin` / –ü–∞—Ä–æ–ª—å: `zabbix`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ MediaWiki –Ω–∞ —É—Ä–æ–≤–Ω–µ:
  - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ HTTP (–∫–æ–¥ + –∑–∞–¥–µ—Ä–∂–∫–∞)
  - —Å–æ—Å—Ç–æ—è–Ω–∏—è Zabbix-–∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –≤—Å–µ—Ö —Ö–æ—Å—Ç–∞—Ö

üëâ –î–æ–±–∞–≤–∏—Ç—å —Ö–æ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –ø—Ä–∏–≤—è–∑–∞—Ç—å —à–∞–±–ª–æ–Ω `Template App HTTP Service`.

---

## üîÅ –†–µ–ø–ª–∏–∫–∞—Ü–∏—è PostgreSQL

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `pg_basebackup` –∏ `standby.signal`
- –†–µ–ø–ª–∏–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ `hot standby`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ:

```bash
sudo -u postgres psql -c "SELECT * FROM pg_stat_replication;"
```

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ:

```bash
sudo -u postgres psql -c "SELECT pg_is_in_recovery();"
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π                               | –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ                            |
|----------------------------------------|-------------------------------------------------|
| –í—ã–∫–ª—é—á–µ–Ω–∏–µ `mediawiki-1`               | Nginx –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å `mediawiki-2`      |
| –í—ã–∫–ª—é—á–µ–Ω–∏–µ `pg-master`                 | `pg-replica` –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é              |
| –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ MediaWiki            | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ `tar`-–∞—Ä—Ö–∏–≤–∞              |
| –£–¥–∞–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö                   | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ `pg_dump`                 |

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
Terraform/
‚îú‚îÄ‚îÄ main.tf
‚îú‚îÄ‚îÄ variables.tf
‚îú‚îÄ‚îÄ terraform.tfvars
‚îú‚îÄ‚îÄ providers.tf
‚îú‚îÄ‚îÄ outputs.tf
‚îú‚îÄ‚îÄ versions.tf

ansible/
‚îú‚îÄ‚îÄ inventory.yaml
‚îú‚îÄ‚îÄ ansible.cfg
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îî‚îÄ‚îÄ all.yml
‚îú‚îÄ‚îÄ site.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/main.yml + files/nginx.conf
‚îÇ   ‚îú‚îÄ‚îÄ mediawiki/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îú‚îÄ‚îÄ zabbix/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ files/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ backup_fs.sh
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ backup_db.sh
‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ       ‚îî‚îÄ‚îÄ tasks/main.yml (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ zabbix-agent)
```

---
## –°—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞

üë§ [User] 
   ‚Üì
‚òÅÔ∏è [–ò–Ω—Ç–µ—Ä–Ω–µ—Ç]
   ‚Üì
üßÆ [nginx-lb] ‚Äî –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
   ‚Üì               ‚Üì
üñ•Ô∏è [mediawiki-1]   üñ•Ô∏è [mediawiki-2]
     ‚Üì                   ‚Üì
üõ¢Ô∏è [pg-master]  ‚Üê  —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è  ‚Üí üõ¢Ô∏è [pg-replica]

           üîÑ Streaming replication

üõ°Ô∏è [backup-zabbix] ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + –±—ç–∫–∞–ø
     ‚Üò fs backup ‚Üí [mediawiki-1]
     ‚Üò fs backup ‚Üí [mediawiki-2]
     ‚Üò pg_dump   ‚Üí [pg-master]

     ‚Üò –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Üí [nginx-lb]
     ‚Üò –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Üí [pg-replica]

---

## üèÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- –ü—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è MediaWiki
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã: –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –±—ç–∫–∞–ø
- –í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–∞–ª—å–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏

**–ê–ª–µ–∫—Å–µ–π –ü–æ—Ç–∞–Ω–∏–Ω**   [avpotanin@gmail.com](mailto:avpotanin@gmail.com)
GitHub: [https://github.com/potashka](https://github.com/potashka)